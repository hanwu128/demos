<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- DT实例 -->
<mapper namespace="com.lenovo.iot.digitaltwin.ist.front">
    <!--
        查询DT实例总数
    -->
    <select id="getTotal" resultType="java.lang.Integer">
        select count(1) as total
        from dt_instance
        where name like #{name}
    </select>

    <!--
        查询DT实例列表
    -->
    <select id="getList" resultMap="dtIstListResultMap">
        select
            ist.id as ist_id,
            ist.tpl as ist_tpl,
            ist.name as ist_name,
            ist.desp as ist_desp,
            tpl.name as ist_tplname,
            count(ist_attr.id) as ist_num,
            ist.ctime as ist_ctime,
            ist.mtime as ist_mtime,
            ist.atime as ist_atime
        from dt_instance as ist
        left join dt_tpl as tpl
            on ist.tpl = tpl.id
        left join dt_instance_atrr as ist_attr
            on ist.id = ist_attr.instance
        where ist.name like #{name} and ist.uid = #{uid}
        group by ist.id
        order by ist_ctime desc
        limit #{start}, #{offset}
    </select>
    <resultMap id="dtIstListResultMap" type="DigitalTwinInstance">
        <id property="id" column="ist_id"/>
        <id property="tpl" column="ist_tpl"/>
        <result property="name" column="ist_name"/>
        <result property="desp" column="ist_desp"/>
        <result property="tplname" column="ist_tplname"/>
        <result property="attrnum" column="ist_num"/>
        <result property="ctime" column="ist_ctime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="mtime" column="ist_mtime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="atime" column="ist_atime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
    </resultMap>

    <!-- 查询DT实例 -->
    <select id="getById" resultMap="dtIstResultMap">
        select
            ist.id as ist_id,
            ist.tpl as ist_tpl,
            ist.name as ist_name,
            ist.desp as ist_desp,
            ist.ctime as ist_ctime,
            ist.mtime as ist_mtime,
            ist.atime as ist_atime
        from dt_instance as ist
            where id = #{id};
    </select>
    <resultMap id="dtIstResultMap" type="DigitalTwinInstance">
        <id property="id" column="ist_id"/>
        <result property="tpl" column="ist_tpl"/>
        <result property="name" column="ist_name"/>
        <result property="desp" column="ist_desp"/>
        <result property="ctime" column="ist_ctime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="mtime" column="ist_mtime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="atime" column="ist_atime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
    </resultMap>

    <!--
        查询DT实例详情
    -->
    <select id="getDetailById" resultMap="dtIstDetailResultMap">
        select
            ist.id as ist_id,
            ist.tpl as ist_tpl,
            ist.name as ist_name,
            ist.desp as ist_desp,
            tpl.name as ist_tplname,
            ist.ctime as ist_ctime,
            ist.mtime as ist_mtime,
            ist.atime as ist_atime,
            istattr.id as istattr_id,
            istattr.instance as istattr_instance,
            istattr.name as istattr_name,
            istattr.displayname as istattr_displayname,
            istattr.attrtype as istattr_attrtype,
            istattr.datatype as istattr_datatype,
            istattr.value as istattr_value,
            istattr.expectvalue as istattr_expectvalue,
            istattr.unit as istattr_unit,
            istattr.metric as istattr_metric,
            istattr.deviceid as istattr_deviceid,
            istattr.ctime as istattr_ctime,
            istattr.mtime as istattr_mtime,
            istattr.atime as istattr_atime,
            istattr.stime as istattr_stime
        from dt_instance as ist
        left join dt_tpl as tpl
            on ist.tpl = tpl.id
        left join dt_instance_atrr as istattr
            on ist.id = istattr.instance
        where ist.id = #{id} order by istattr.attrtype desc,istattr.id asc;
    </select>
    <resultMap id="dtIstDetailResultMap" type="DigitalTwinInstance">
        <id property="id" column="ist_id"/>
        <result property="tpl" column="ist_tpl"/>
        <result property="name" column="ist_name"/>
        <result property="desp" column="ist_desp"/>
        <result property="tplname" column="ist_tplname"/>
        <result property="ctime" column="ist_ctime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="mtime" column="ist_mtime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <result property="atime" column="ist_atime" typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        <collection property="attr" ofType="DigitalTwinInstanceAttr">
            <id property="id" column="istattr_id"/>
            <result property="instance" column="istattr_instance"/>
            <result property="name" column="istattr_name"/>
            <result property="displayname" column="istattr_displayname"/>
            <result property="attrtype" column="istattr_attrtype"/>
            <result property="datatype" column="istattr_datatype"/>
            <result property="value" column="istattr_value"/>
            <result property="expectvalue" column="istattr_expectvalue"/>
            <result property="unit" column="istattr_unit"/>
            <result property="metric" column="istattr_metric"/>
            <!--<result property="tags" column="istattr_tags" typeHandler="com.lenovo.iot.digitaltwin.handler.JsonTypeHandler" />-->
            <result property="deviceid" column="istattr_deviceid"/>
            <result property="ctime" column="istattr_ctime"
                    typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
            <result property="mtime" column="istattr_mtime"
                    typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
            <result property="atime" column="istattr_atime"
                    typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
            <result property="stime" column="istattr_stime"
                    typeHandler="com.lenovo.iot.digitaltwin.handler.Time2LongHandler"/>
        </collection>
    </resultMap>

    <!--
        添加DT实例
    -->
    <insert id="add" parameterType="DigitalTwinInstance" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into dt_instance(tpl,name,desp,uid,gid,ctime,mtime) values(#{tpl},#{name},#{desp},#{uid},#{gid},now(),now())
    </insert>


    <!--
        编辑DT实例
    -->
    <update id="update" parameterType="DigitalTwinInstance">
        update dt_instance set name = #{name}, desp = #{desp}, mtime = now(), tpl = #{tpl} where id = #{id}
    </update>

    <!--
        删除DT实例，支持批量删除。
        只能删除未被实时数据流使用的物实例。
    -->
    <delete id="delete" parameterType="java.util.List">
        delete from dt_instance where id IN (
        <foreach collection="list" item="id" separator=",">
            #{id}
        </foreach>
        )
        and lockup=0
    </delete>

    <!-- 根据名称查询DT实例 -->
    <select id="getByName" resultType="DigitalTwinInstance">
        select id,name from dt_instance where name=#{name}
    </select>

    <!-- 根据ID查询DT实例,支持批量查询 -->
    <select id="getByListId" resultType="DigitalTwinInstance">
        select id,name,lockup from dt_instance where id in
        (<foreach collection="list" item="id" separator=",">
        #{id}
        </foreach>)
        and lockup = 1
    </select>

</mapper>