<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lenovo.iot.devicemanager.dao.ITaskDao">
	<insert id="doInsertTask" useGeneratedKeys="true" keyProperty="id" parameterType="TaskVO">
	INSERT INTO
		task(
					  company_id,
					 `appid`,
					  deviceid,
					  createtimeat,
					  updatetimeat,
					  taskcode,
					  devicestatus,
					  appstatus,
					  jarappmdfive,
					  jarfilewholeforder,
					  taskownerid,
					  taskdeploypolicyexpression,
					  taskstatus,
					  classname
					  )
	VALUES
		(#{companyid},
		 #{appid},
		 #{deviceid},
		 #{createtimeat},
		 #{updatetimeat},
		 #{taskcode},
		 #{devicestatus},
		 #{appstatus},
		 #{jarappmdfive},
		 #{jarfilewholeforder},
		 #{taskownerid},
		 #{taskdeploypolicyexpression},
		 #{taskstatus},
		 #{classname}
		)
	</insert>

	<select id="findAllApacheAdgentMetaData" resultType="com.lenovo.iot.devicemanager.model.bo.ApacheAdgentMetaData">
		SELECT 
			id,
			`json_version`,
			hardware_manufactor,
			hardware_model,
			hardware_device_id,
			hardware_location,
			customer_id,
			hardware_os,
			hardware_os_version,
			firmware_version,
			app_key,
			edgent_agent_version,
			edgent_agent_app_list,
			console_url,
			timestampat

		FROM 
			apacheadgentmetadata t
	</select>

	<select id="findApacheAdgentMetaDataByParameter" resultType="com.lenovo.iot.devicemanager.model.bo.ApacheAdgentMetaData" parameterType="ApacheAdgentMetaData">
		SELECT
		id,
		`json_version`,
		hardware_manufactor,
		hardware_model,
		hardware_device_id,
		hardware_location,
		customer_id,
		hardware_os,
		hardware_os_version,
		firmware_version,
		app_key,
		edgent_agent_version,
		edgent_agent_app_list,
		console_url,
		timestampat

		FROM
		apacheadgentmetadata t

		WHERE
		1 = 1
		<if test="hardware_manufactor != null and hardware_manufactor != '' and hardware_device_id != null and hardware_device_id != ''">
			AND  hardware_manufactor = #{hardware_manufactor} AND hardware_device_id = #{hardware_device_id}
		</if>



	</select>



	<select id="findAllTask" resultType="com.lenovo.iot.devicemanager.model.bo.TaskVO" parameterType="TaskVO">
		SELECT
		SUBSTRING(from_unixtime(substring(t.createtimeat, 1, 10) ) ,1,19) as createtimeatshow,
		t.id ,
		t.appid,
		t.deviceid,
		t.createtimeat,
		t.appstatus,
		t.devicestatus,
		t.taskstatus,
		tt.appname,
		tt.apptype,
		tt.appfilename,
		tt.appversion,
		ttt.device_id as devicecode
		from task t LEFT JOIN app tt ON t.appid = tt.id
		LEFT JOIN device ttt ON t.deviceid = ttt.id
		WHERE
		1 = 1
	</select>

	<select id="findTasklistbyparameters" resultType="com.lenovo.iot.devicemanager.model.bo.TaskVO" parameterType="TaskVO">
		SELECT
		SUBSTRING(from_unixtime(substring(t.createtimeat, 1, 10) ) ,1,19) as createtimeatshow,
		t.id ,
		t.company_id as companyid,
		t.appid,
		t.deviceid,
		t.createtimeat,
		t.appstatus,
		t.devicestatus,
		t.taskstatus,
		tt.appname,
		tt.apptype,
		tt.appfilename,
		tt.appversion,
		ttt.access_key as accesskey
		from task t LEFT JOIN app tt ON t.appid = tt.id
		LEFT JOIN device ttt ON t.deviceid = ttt.device_id

		WHERE

		1 = 1

		<if test="companyid != null and companyid != 0 ">
			AND t.company_id = #{companyid}
		</if>

		<if test="appid != null and appid != 0 ">
			AND t.appid = #{appid}
		</if>

		<if test="device_id != null and device_id != '' ">
			AND t.deviceid = #{device_id}
		</if>

		<if test="taskstatus != null and taskstatus != '' ">
			AND t.taskstatus = #{taskstatus}
		</if>

		<if test="id != null and id != 0 ">
			AND t.id = #{id}
		</if>

		<if test="appname != null and appname != '' ">
			AND tt.appname = #{appname}
		</if>

		<if test="apptype != null and apptype != '' ">
			AND tt.apptype = #{apptype}
		</if>

		<if test="sort_orderby != null and sort_orderby != ''">
        	order by ${sort_orderby} ${sort_rule}
        </if>
        
		<if test="limitStart != null and limitStart != -1 and limitEnd != null and limitEnd != 0 ">
			limit #{limitStart} , #{limitEnd}
		</if>

	</select>
	<select id="findTasklistcountbyparameters" resultType="Integer" parameterType="TaskVO">
		SELECT
		count(t.id)
		from task t LEFT JOIN app tt ON t.appid = tt.id
		LEFT JOIN device ttt ON t.deviceid = ttt.device_id

		WHERE

		1 = 1

		<if test="companyid != null and companyid != 0 ">
			AND t.company_id = #{companyid}
		</if>

		<if test="appid != null and appid != 0 ">
			AND t.appid = #{appid}
		</if>

		<if test="device_id != null and device_id != '' ">
			AND t.deviceid = #{device_id}
		</if>

		<if test="taskstatus != null and taskstatus != '' ">
			AND t.taskstatus = #{taskstatus}
		</if>

		<if test="id != null and id != 0 ">
			AND t.id = #{id}
		</if>

		<if test="appname != null and appname != '' ">
			AND tt.appname = #{appname}
		</if>

		<if test="apptype != null and apptype != '' ">
			AND tt.apptype = #{apptype}
		</if>

	</select>




	<update id="doUpdateTask" parameterType="com.lenovo.iot.devicemanager.model.bo.TaskVO">
		UPDATE task
		<set>
			<if test="appid != null and appid != 0">
				appid = #{appid},
			</if>

			<if test="deviceid != null and deviceid != ''">
				deviceid = #{deviceid},
			</if>

			<if test="createtimeat != null and createtimeat != ''">
				createtimeat = #{createtimeat},
			</if>

			<if test="updatetimeat != null and updatetimeat != ''">
				updatetimeat = #{updatetimeat},
			</if>

			<if test="taskcode != null and taskcode != ''">
				taskcode = #{taskcode},
			</if>

			<if test="devicestatus != null and devicestatus != ''">
				devicestatus = #{devicestatus},
			</if>

			<if test="appstatus != null and appstatus != ''">
				appstatus = #{appstatus},
			</if>

			<if test="jarappmdfive != null and jarappmdfive != ''">
				jarappmdfive = #{jarappmdfive},
			</if>

			<if test="jarfilewholeforder != null and jarfilewholeforder != ''">
				jarfilewholeforder = #{jarfilewholeforder},
			</if>

			<if test="taskownerid != null and taskownerid != ''">
				taskownerid = #{taskownerid},
			</if>

			<if test="taskdeploypolicyexpression != null and taskdeploypolicyexpression != ''">
				taskdeploypolicyexpression = #{taskdeploypolicyexpression},
			</if>

			<if test="taskstatus != null and taskstatus != ''">
				taskstatus = #{taskstatus},
			</if>
		</set>
		WHERE id = #{id}
	</update>


	<delete id="doDeleteTask" parameterType="com.lenovo.iot.devicemanager.model.bo.TaskVO">
		DELETE FROM task WHERE id = #{id}
	</delete>

	<delete id="doDeleteApp" parameterType="com.lenovo.iot.devicemanager.model.bo.TaskVO">
		DELETE FROM app WHERE id = #{appid}
	</delete>

	<update id="doUpdateTaskByAppname" parameterType="com.lenovo.iot.devicemanager.model.bo.TaskVO">
		UPDATE task
		<set>
			appstatus = #{appstatus}
		</set>
		WHERE deviceid = #{deviceid} and appid in (select id  from app where appname = #{appname})
	</update>


</mapper>